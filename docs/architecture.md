# Simple OS 아키텍처 문서

## 1. 프로젝트 목표 및 요구사항

### 1.1 핵심 목표

1. **독립적인 OS 커널 개발**
   - Rust로 작성된 완전히 독립적인 운영체제 커널
   - 리눅스 커널과 완전히 독립적인 구현
   - 표준 라이브러리(`std`) 없이 `no_std` 환경에서 동작

2. **초저전력 설계**
   - 노트북 환경에 최적화된 전력 관리
   - ACPI 기반 전력 제어
   - 동적 CPU 클럭 스케일링 (DVFS)
   - 효율적인 유휴 상태 관리

3. **메모리 안전성**
   - Rust의 타입 시스템과 메모리 안전성 보장
   - 커널 레벨 버그 최소화
   - 메모리 안전성과 성능의 균형

4. **확장 가능한 모듈형 구조**
   - 명확한 모듈 경계
   - 드라이버 인터페이스 표준화
   - 쉬운 유지보수 및 확장

### 1.2 비기능적 요구사항

| 항목 | 목표 값 | 측정 방법 |
|------|---------|-----------|
| 부팅 시간 | 5초 이내 | 부트 시작부터 Shell 대기까지 |
| 유휴 전력 소비 | 5W 이하 | 전력 측정 도구로 측정 |
| 메모리 사용량 | 최소 64MB | 커널 실행 시 메모리 사용량 모니터링 |
| 안정성 | 커널 패닉 없는 장시간 운영 | 스트레스 테스트 |

### 1.3 기능적 요구사항

**MVP (Minimum Viable Product):**
- [ ] 기본 커널 부팅 및 초기화
- [ ] 텍스트 출력 (VGA 또는 시리얼)
- [ ] 인터럽트 처리
- [ ] 기본 메모리 관리
- [ ] 간단한 Shell

**Phase 1 (초기 단계):**
- [ ] 인터럽트 핸들러 구현
- [ ] 메모리 관리 (물리/가상)
- [ ] 기본 드라이버 (타이머, 키보드, VGA)
- [ ] 프로세스 스케줄러
- [ ] 시스템 콜 인터페이스

**Phase 2 (중기 단계):**
- [ ] 전력 관리 시스템 (ACPI 파싱)
- [ ] 동적 전력 스케일링
- [ ] 파일시스템 (FAT32)
- [ ] 네트워크 드라이버 및 스택

**Phase 3 (후기 단계):**
- [ ] GUI 시스템
- [ ] 멀티코어 지원
- [ ] 고급 전력 관리 (Sleep/Resume)
- [ ] 보안 기능 강화

## 2. 시스템 아키텍처

### 2.1 전체 시스템 구조

```
┌─────────────────────────────────────────────┐
│         Application Layer                   │
│   ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│   │  Shell   │  │   GUI    │  │  User   │ │
│   │          │  │          │  │  Apps   │ │
│   └──────────┘  └──────────┘  └─────────┘ │
└─────────────────────────────────────────────┘
                    ↕ System Calls
┌─────────────────────────────────────────────┐
│         System Call Interface               │
│   (syscall handler, parameter validation)   │
└─────────────────────────────────────────────┘
                    ↕
┌─────────────────────────────────────────────┐
│         Kernel Core                         │
│   ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│   │Scheduler │  │  Memory  │  │ Process │ │
│   │          │  │  Manager │  │ Manager │ │
│   └──────────┘  └──────────┘  └─────────┘ │
│   ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│   │  Power   │  │  Driver  │  │   FS    │ │
│   │  Mgmt    │  │  Manager │  │ Manager │ │
│   └──────────┘  └──────────┘  └─────────┘ │
└─────────────────────────────────────────────┘
                    ↕
┌─────────────────────────────────────────────┐
│         Hardware Abstraction Layer (HAL)    │
│   ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│   │Interrupt │  │  Timer   │  │   MMIO  │ │
│   │ Handler  │  │          │  │         │ │
│   └──────────┘  └──────────┘  └─────────┘ │
└─────────────────────────────────────────────┘
                    ↕
┌─────────────────────────────────────────────┐
│         Hardware Layer                      │
│   (CPU, Memory, I/O Devices, Interrupts)   │
└─────────────────────────────────────────────┘
```

### 2.2 커널 모듈 구조

```
kernel/
├── boot/              # 부트로더 인터페이스 및 초기화
│   ├── mod.rs
│   ├── multiboot.rs   # Multiboot 정보 파싱
│   └── init.rs        # 커널 초기화
│
├── memory/            # 메모리 관리
│   ├── mod.rs
│   ├── allocator.rs   # 힙 할당자
│   ├── paging.rs      # 가상 메모리 페이징
│   ├── frame.rs       # 물리 메모리 프레임 관리
│   └── heap.rs        # 힙 초기화
│
├── scheduler/         # 프로세스/스레드 스케줄러
│   ├── mod.rs
│   ├── process.rs     # 프로세스 구조
│   ├── thread.rs      # 스레드 구조
│   └── round_robin.rs # Round-Robin 스케줄러
│
├── power/             # 전력 관리
│   ├── mod.rs
│   ├── acpi.rs        # ACPI 테이블 파싱
│   ├── scaling.rs     # 동적 클럭 스케일링
│   └── policy.rs      # 전력 정책 관리
│
├── drivers/           # 하드웨어 드라이버
│   ├── mod.rs
│   ├── keyboard.rs    # PS/2 키보드
│   ├── vga.rs         # VGA 텍스트 모드
│   ├── timer.rs       # PIT/HPET 타이머
│   ├── serial.rs      # UART 시리얼 포트
│   └── ata.rs         # ATA/SATA 저장장치
│
├── interrupts/        # 인터럽트 핸들러
│   ├── mod.rs
│   ├── idt.rs         # IDT 설정
│   ├── handlers.rs    # 인터럽트 핸들러
│   └── pic.rs         # PIC 리매핑
│
├── sync/              # 동기화 프리미티브
│   ├── mod.rs
│   ├── spinlock.rs    # 스핀락
│   ├── mutex.rs       # 뮤텍스
│   └── semaphore.rs   # 세마포어
│
├── syscall/           # 시스템 콜 인터페이스
│   ├── mod.rs
│   ├── handler.rs     # 시스템 콜 핸들러
│   └── numbers.rs     # 시스템 콜 번호 정의
│
├── fs/                # 파일시스템 인터페이스
│   ├── mod.rs
│   ├── vfs.rs         # 가상 파일시스템
│   └── fat32.rs       # FAT32 구현
│
└── net/               # 네트워크 스택
    ├── mod.rs
    ├── ethernet.rs    # 이더넷 드라이버
    └── ip.rs          # IP 프로토콜
```

### 2.3 메모리 레이아웃

```
Virtual Address Space (x86_64):
┌─────────────────────────────────┐ 0xFFFFFFFFFFFFFFFF
│         Guard Page              │
├─────────────────────────────────┤
│         Kernel Stack            │ (스레드당 8KB)
├─────────────────────────────────┤
│         Kernel Heap              │ (동적 할당)
├─────────────────────────────────┤
│         Kernel Code/Data         │ (커널 바이너리)
├─────────────────────────────────┤
│         User Space               │ (프로세스별)
│         ┌───────────────────┐   │
│         │  Stack (down)     │   │
│         ├───────────────────┤   │
│         │  (grows down)     │   │
│         ├───────────────────┤   │
│         │                   │   │
│         ├───────────────────┤   │
│         │  Heap (up)        │   │
│         │  (grows up)       │   │
│         ├───────────────────┤   │
│         │  Data/BSS         │   │
│         ├───────────────────┤   │
│         │  Code             │   │
│         └───────────────────┘   │
└─────────────────────────────────┘ 0x0000000000000000
```

### 2.4 부팅 프로세스

1. **BIOS/UEFI 부트**
   - 펌웨어가 부트 디스크에서 부트로더 로드
   - 부트로더가 커널 바이너리 로드

2. **커널 초기화 (`_start`)**
   - 레지스터 초기화
   - 스택 설정
   - 메모리 맵 파싱

3. **커널 모듈 초기화**
   - 인터럽트 디스크립터 테이블 (IDT) 설정
   - 메모리 관리자 초기화
   - 힙 할당자 초기화
   - 인터럽트 활성화

4. **드라이버 초기화**
   - 시리얼 포트 초기화
   - VGA 초기화
   - 타이머 초기화
   - 키보드 초기화

5. **시스템 서비스 시작**
   - 스케줄러 시작
   - 전력 관리 초기화
   - Shell/GUI 시작

## 3. 기술 스택

### 3.1 언어 및 런타임

- **Rust (nightly)**: 메모리 안전성 보장
- **`no_std` 환경**: 표준 라이브러리 제외
- **`#![no_main]`**: 커스텀 엔트리 포인트
- **`#![feature(...)]`**: 필요한 nightly 기능 사용

### 3.2 필수 크레이트

| 크레이트 | 버전 | 용도 |
|---------|------|------|
| `bootloader` | 0.11+ | 부트로더 통합 |
| `x86_64` | 0.14+ | x86_64 아키텍처 지원 |
| `volatile` | 0.4+ | 하드웨어 레지스터 접근 |
| `spin` | 0.9+ | 스핀락 구현 |
| `linked_list_allocator` | 0.10+ | 힙 할당자 (초기 단계) |
| `uart_16550` | 0.2+ | 시리얼 포트 통신 |

### 3.3 선택적 크레이트 (단계별 도입)

| 크레이트 | 단계 | 용도 |
|---------|------|------|
| `acpi` | Phase 2 | ACPI 테이블 파싱 |
| `pci` | Phase 2 | PCI 디바이스 스캔 |
| `embedded-graphics` | Phase 3 | GUI 프레임워크 |
| `smoltcp` | Phase 2 | 네트워크 스택 |

### 3.4 타겟 아키텍처

- **타겟**: `x86_64-unknown-none`
- **부트 프로토콜**: UEFI (우선), BIOS 레거시 (선택적)
- **페이지 크기**: 4KB
- **주소 공간**: 64비트 가상 주소 공간

## 4. 타겟 하드웨어

### 4.1 지원 아키텍처

- **CPU**: x86_64 (64비트)
- **펌웨어**: UEFI (우선), BIOS 레거시 (선택적)
- **메모리 모델**: 물리 주소 확장 (PAE) 또는 64비트 모드

### 4.2 하드웨어 요구사항

| 구성요소 | 최소 | 권장 |
|---------|------|------|
| CPU | Intel Core 시리즈 또는 AMD Ryzen (x86_64) | Intel 8세대 이상, AMD Ryzen 3000 이상 |
| RAM | 64MB | 512MB 이상 |
| 저장장치 | ATA/SATA HDD/SSD | SSD 권장 |
| 디스플레이 | VGA 텍스트 모드 | VESA 프레임버퍼 |

### 4.3 하드웨어 우선순위

**Phase 1 (필수):**
- CPU (x86_64)
- 메모리 (RAM)
- 시리얼 포트 (디버깅)
- VGA 텍스트 모드
- 키보드 (PS/2)
- 타이머 (PIT)

**Phase 2 (중요):**
- ACPI 지원 (전력 관리)
- 저장장치 (ATA/SATA)
- 네트워크 어댑터

**Phase 3 (선택적):**
- 그래픽 가속
- USB 지원
- 오디오

## 5. 설계 원칙

### 5.1 메모리 안전성

- Rust의 타입 시스템 활용
- `unsafe` 블록 최소화
- 메모리 안전성 검증
- 경계 검사

### 5.2 전력 효율

- 유휴 상태 최적화
- CPU 클럭 동적 조절
- 불필요한 폴링 방지
- 인터럽트 기반 I/O

### 5.3 모듈성

- 명확한 모듈 경계
- 인터페이스 기반 설계
- 낮은 결합도, 높은 응집도
- 테스트 가능한 구조

### 5.4 확장성

- 드라이버 인터페이스 표준화
- 플러그인 방식의 모듈 추가
- 계층화된 아키텍처
- API 버전 관리

## 6. 보안 고려사항

### 6.1 커널 보안

- 시스템 콜 파라미터 검증
- 권한 검사
- 메모리 보호
- 스택 오버플로우 방지

### 6.2 메모리 보안

- 페이지 권한 설정
- ASLR (Address Space Layout Randomization)
- 스택 카나리 (향후)
- 실행 방지 (NX bit)

### 6.3 프로세스 격리

- 페이지 테이블 분리
- 시스템 콜 격리
- 메모리 접근 제어

## 7. 성능 목표

### 7.1 부팅 성능

- 부팅 시간: 5초 이내
- 초기화 시간: 2초 이내
- 메모리 맵 파싱: 100ms 이내

### 7.2 런타임 성능

- 컨텍스트 스위칭: < 10μs
- 시스템 콜 오버헤드: < 1μs
- 인터럽트 지연: < 50μs

### 7.3 전력 성능

- 유휴 전력 소비: 5W 이하
- 활성 전력 효율: 부하에 비례
- 전력 관리 오버헤드: 최소화

## 8. 개발 전략

### 8.1 단계별 개발

1. **기본 인프라**: 부팅, 인터럽트, 메모리
2. **핵심 기능**: 스케줄러, 시스템 콜
3. **드라이버**: 기본 I/O 장치
4. **고급 기능**: 전력 관리, 파일시스템
5. **사용자 인터페이스**: Shell, GUI

### 8.2 테스트 전략

- 단위 테스트: 각 모듈별
- 통합 테스트: 모듈 간 상호작용
- 하드웨어 테스트: 실제 하드웨어 검증
- 성능 테스트: 벤치마크

### 8.3 문서화

- 코드 주석: 모든 공개 API
- 아키텍처 문서: 시스템 설계
- 사용자 매뉴얼: 사용 방법
- 개발자 가이드: 기여 방법

---

**문서 버전**: 1.0  
**최종 업데이트**: 2024년  
**작성자**: Simple OS 개발팀

